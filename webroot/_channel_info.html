<!DOCTYPE html>
<meta charset="utf-8">
<title>Plot1</title>
<style>
body {
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
}

button {
  position: absolute;
  right: 10px;
  top: 10px;
}

#swap-plot {
  position: absolute;
  top: 30px;
  left: 100px;
  z-index: 100;
  font-size: 20px;
}
</style>
<link href="c3-b03125fa.css" media="screen" rel="stylesheet" type="text/css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
<script src="d3-3.5.6.min-77adef17.js" type="text/javascript"></script>
<script src="c3.min-4c5bef8f.js" type="text/javascript"></script>
<button id="swap-plot">Plot Daily Activity</button>
<div id="chart" style="width: 2000px; height: 1000px;"></div>
<script>
var url = window.location.pathname
var filename = url.substring(url.lastIndexOf('/')+1).replace(".html", "")
jQuery.getJSON(filename + ".json", function (data) {
  var all_yyyy_mm_dd = data["all_yyyy_mm_dd"]
  var chart_width = Math.max(960, 4 * all_yyyy_mm_dd.length)
  $("#chart").css("width", "" + chart_width + "px")

  player_message_totals = data["player_message_totals"]
  player_message_counts = data["player_message_counts"]

  var nicks_and_total_messages = []
  for (var nick in data["player_message_totals"]) {
    nicks_and_total_messages.push([nick, player_message_totals[nick]])
  }
  nicks_and_total_messages.sort(function (a, b) {
    if (a[1] < b[1]) {
      return 1
    }
    if (a[1] > b[1]) {
      return -1
    }
    return 0
  })
  var nicks_to_display = []
  for (var i = 0; i < nicks_and_total_messages.length && i < 25; i++) {
    nicks_to_display.push(nicks_and_total_messages[i][0])
  }

  var activity_classes = []
  var sum_classes = []
  var x_class = ["x"].concat(all_yyyy_mm_dd)
  activity_classes.push(x_class)
  sum_classes.push(x_class)

  for (var i in nicks_to_display) {
    var nick = nicks_to_display[i]
    var nick_activity_class = [nick]
    var nick_sum_class = [nick]
    var nick_message_counts = player_message_counts[nick]
    var acc = 0
    for (var j in all_yyyy_mm_dd) {
      var yyyy_mm_dd = all_yyyy_mm_dd[j]
      count = 0
      if (yyyy_mm_dd in nick_message_counts) {
        count = nick_message_counts[yyyy_mm_dd]
      }
      acc += count
      nick_activity_class.push(count)
      nick_sum_class.push(acc)
    }
    activity_classes.push(nick_activity_class)
    sum_classes.push(nick_sum_class)
  }

  var channel_total_class = [filename]
  var channel_activity_class = [filename]
  var channel_total_acc = 0
  for (var j in all_yyyy_mm_dd) {
    var yyyy_mm_dd = all_yyyy_mm_dd[j]
    var yyyy_mm_dd_count = 0
    for (var nick in player_message_counts) {
      var nick_message_counts = player_message_counts[nick]
      if (yyyy_mm_dd in nick_message_counts) {
        yyyy_mm_dd_count += nick_message_counts[yyyy_mm_dd]
      }
    }
    channel_activity_class.push(yyyy_mm_dd_count)
    channel_total_acc += yyyy_mm_dd_count
    channel_total_class.push(channel_total_acc)
  }
  // @TODO: Make channel totals toggleable. They tend to be 6x the 25-most-active users,
  // which eliminates a meaningful look at individuals.
  //sum_classes.push(channel_total_class)
  //activity_classes.push(channel_activity_class)

  for (var i in nicks_to_display) {
    var nick = nicks_to_display[i]
    var nick_activity_class = [nick]
    var nick_sum_class = [nick]
    var nick_message_counts = player_message_counts[nick]
    var acc = 0
    for (var j in all_yyyy_mm_dd) {
      var yyyy_mm_dd = all_yyyy_mm_dd[j]
      count = 0
      if (yyyy_mm_dd in nick_message_counts) {
        count = nick_message_counts[yyyy_mm_dd]
      }
      acc += count
      nick_activity_class.push(count)
      nick_sum_class.push(acc)
    }
    activity_classes.push(nick_activity_class)
    sum_classes.push(nick_sum_class)
  }

  var chart = c3.generate({
    data: {
      x: 'x',
      columns: sum_classes
    },
    tooltip: {
      grouped: true
    },
    point: {
      show: false
    },
    axis: {
      x: {
        type : 'timeseries',
        tick: {
          fit: true,
          format: "%e %b %y"
        }
      },
      y: {
        min: 0,
        padding: 0
      }
    }
  });

  $("#swap-plot").on("click", function () {
    chart.load({
      unload: true,
      columns: activity_classes
    })
    //$("#swap-plot").text($("#swap-plot").attr("data-alt-text"))
  })

  /*setTimeout(function () {
    chart.unload({
        ids: 'data1'
    });*/

})
</script>
